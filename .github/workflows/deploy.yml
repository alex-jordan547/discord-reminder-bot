name: ğŸš€ Deploy Application

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Target environment (preprod/production)'
      image-tag:
        required: true
        type: string
        description: 'Docker image tag to deploy'
      image-digest:
        required: false
        type: string
        description: 'Docker image digest for verification'
    secrets:
      DEPLOY_PRIVATE_KEY:
        required: false
      PREPROD_HOST:
        required: false
      PRODUCTION_HOST:
        required: false
      DISCORD_BOT_TOKEN:
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-deployment:
    name: ğŸ” Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      deploy-url: ${{ steps.config.outputs.deploy-url }}
      health-check-url: ${{ steps.config.outputs.health-check-url }}
    steps:
      - name: âœ… Validate inputs
        run: |
          if [[ ! "${{ inputs.environment }}" =~ ^(preprod|production)$ ]]; then
            echo "âŒ Invalid environment: ${{ inputs.environment }}"
            exit 1
          fi
          
          if [[ -z "${{ inputs.image-tag }}" ]]; then
            echo "âŒ Image tag is required"
            exit 1
          fi
          
          echo "âœ… Deployment validation passed"
          echo "ğŸ¯ Environment: ${{ inputs.environment }}"
          echo "ğŸ·ï¸ Image: ${{ inputs.image-tag }}"
      
      - name: âš™ï¸ Set environment config
        id: config
        run: |
          if [[ "${{ inputs.environment }}" == "production" ]]; then
            echo "deploy-url=https://discord-bot.yourcompany.com" >> $GITHUB_OUTPUT
            echo "health-check-url=https://discord-bot.yourcompany.com/health" >> $GITHUB_OUTPUT
          else
            echo "deploy-url=https://preprod-discord-bot.yourcompany.com" >> $GITHUB_OUTPUT
            echo "health-check-url=https://preprod-discord-bot.yourcompany.com/health" >> $GITHUB_OUTPUT
          fi

  deploy-to-environment:
    name: ğŸš€ Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: validate-deployment
    environment:
      name: ${{ inputs.environment }}
      url: ${{ needs.validate-deployment.outputs.deploy-url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ”‘ Setup SSH Key
        if: inputs.environment == 'production'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“‹ Prepare deployment
        run: |
          echo "ğŸš€ Preparing deployment for ${{ inputs.environment }}"
          echo "ğŸ·ï¸ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image-tag }}"
          
          # Create deployment manifest
          cat > deployment.yaml << EOF
          version: '3.8'
          services:
            discord-bot:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image-tag }}
              environment:
                - NODE_ENV=${{ inputs.environment }}
                - DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }}
              restart: unless-stopped
              ports:
                - "3000:3000"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          EOF
          
          echo "ğŸ“„ Deployment manifest ready"
      
      - name: ğŸš€ Execute deployment
        run: |
          echo "ğŸš€ Deploying to ${{ inputs.environment }}"
          
          # Simulate deployment - replace with your actual deployment logic
          if [[ "${{ inputs.environment }}" == "production" ]]; then
            echo "ğŸ­ Production deployment logic"
            # ssh user@${{ secrets.PRODUCTION_HOST }} "docker-compose -f /path/to/compose.yml up -d"
          else
            echo "ğŸ§ª Preprod deployment logic" 
            # kubectl apply -f deployment.yaml --namespace=preprod
          fi
          
          echo "âœ… Deployment completed"
      
      - name: â³ Wait for service startup
        run: |
          echo "â³ Waiting for service to be ready..."
          sleep 30
          echo "âœ… Service startup wait completed"

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: [validate-deployment, deploy-to-environment]
    steps:
      - name: ğŸ¥ Verify service health
        run: |
          HEALTH_URL="${{ needs.validate-deployment.outputs.health-check-url }}"
          echo "ğŸ¥ Checking health at: $HEALTH_URL"
          
          # Simulate health check - replace with actual health check
          for i in {1..10}; do
            echo "ğŸ” Health check attempt $i/10"
            # if curl -f "$HEALTH_URL"; then
            #   echo "âœ… Health check passed"
            #   exit 0
            # fi
            # For now, simulate success
            if [[ $i -eq 3 ]]; then
              echo "âœ… Health check passed (simulated)"
              break
            fi
            echo "â³ Waiting 30s before retry..."
            sleep 30
          done
          
          echo "âœ… Service is healthy"

  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [validate-deployment, health-check]
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ’¨ Run smoke tests
        run: |
          BASE_URL="${{ needs.validate-deployment.outputs.deploy-url }}"
          echo "ğŸ’¨ Running smoke tests against: $BASE_URL"
          
          # Simulate smoke tests - replace with actual tests
          echo "âœ… API endpoints responding"
          echo "âœ… Database connectivity verified"
          echo "âœ… Discord bot connection active" 
          echo "âœ… Core functionality working"
          
          echo "ğŸ‰ All smoke tests passed!"

  post-deployment:
    name: ğŸ“Š Post Deployment
    runs-on: ubuntu-latest
    needs: [validate-deployment, deploy-to-environment, health-check, smoke-tests]
    if: always()
    steps:
      - name: ğŸ“Š Deployment summary
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Validation | ${{ needs.validate-deployment.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deployment | ${{ needs.deploy-to-environment.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¥ Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’¨ Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ inputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ needs.validate-deployment.outputs.deploy-url }}" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notify teams
        if: inputs.environment == 'production'
        run: |
          if [[ "${{ needs.deploy-to-environment.result }}" == "success" ]]; then
            echo "ğŸ‰ Production deployment successful!"
            echo "ğŸŒŸ New version ${{ inputs.image-tag }} is live"
          else
            echo "âŒ Production deployment failed!"
            echo "ğŸš¨ Immediate attention required"
          fi